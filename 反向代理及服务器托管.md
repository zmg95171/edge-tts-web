# 反向代理及服务器托管指南

本文档提供Edge-TTS Web应用的完整自托管解决方案，包括域名配置、反向代理设置和服务器部署流程。

## 目录
1. [域名准备](#域名准备)
2. [服务器准备](#服务器准备)
3. [Nginx反向代理配置](#nginx反向代理配置)
4. [SSL证书配置](#ssl证书配置)
5. [项目部署](#项目部署)
6. [常见问题解决](#常见问题解决)

## 域名准备

### 域名购买
推荐域名注册商：
- 阿里云万网
- 腾讯云
- Cloudflare
- Namecheap

### DNS配置
1. 登录域名服务商控制台
2. 添加A记录，指向服务器公网IP：
   ```
   记录类型: A
   主机记录: @ (或www)
   记录值: 你的服务器公网IP
   TTL: 600 (或默认值)
   ```
3. 如需子域名，添加相应A记录：
   ```
   记录类型: A
   主机记录: api
   记录值: 你的服务器公网IP
   TTL: 600
   ```

## 服务器准备

### 系统要求
- Ubuntu 20.04 LTS 或 CentOS 8 或更高版本
- 至少1GB内存
- 至少10GB存储空间
- 公网IP地址
- 已配置域名解析

### 基础软件安装
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git nginx certbot python3-certbot-nginx

# 安装Node.js (使用NodeSource)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2进程管理器
sudo npm install -g pm2
```

## Nginx反向代理配置

### 基本配置
创建Nginx站点配置文件：
```bash
sudo nano /etc/nginx/sites-available/edge-tts
```

配置内容：
```nginx
# HTTP到HTTPS重定向
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Let's Encrypt验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS主配置
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSL证书配置 (将由Certbot自动填充)
    # ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # 网站根目录
    root /var/www/edge-tts;
    index index.html index.htm;
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API代理配置
    location /api/ {
        proxy_pass https://tts.2068.online;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private must-revalidate auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript;
}
```

启用站点：
```bash
sudo ln -s /etc/nginx/sites-available/edge-tts /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## SSL证书配置

### 使用Let's Encrypt获取免费SSL证书
```bash
# 创建certbot目录
sudo mkdir -p /var/www/certbot

# 获取SSL证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 远程API服务集成

### 当前API配置
- **前端**: 运行在端口3111
- **TTS远程服务**: `https://tts.2068.online`
- **Whisper远程服务**: `https://Whisper.2068.online`

### Vite代理配置
```typescript
// vite.config.ts
server: {
  port: 3111,
  host: '0.0.0.0',
  allowedHosts: [
    'localhost',
    '127.0.0.1',
    'audiogen.2068.online'
  ],
  proxy: {
    '/api/tts': {
      target: 'https://tts.2068.online',
      changeOrigin: true,
      secure: false,
    },
    '/api/whisper': {
      target: 'https://Whisper.2068.online',
      changeOrigin: true,
      secure: false,
    }
  }
}
```

**注意**：`allowedHosts`配置是必需的，特别是在反向代理环境下。如果您的应用运行在其他域名下，请将该域名添加到allowedHosts数组中。

## 项目部署

### 构建前端项目
```bash
# 在本地构建项目
npm run build

# 上传到服务器
scp -r dist/* user@yourserver:/var/www/edge-tts/
```

### 服务器端部署
1. 克隆项目到服务器：
```bash
cd /var
sudo git clone https://github.com/yourusername/edge-tts-web.git
cd edge-tts-web
```

2. 安装依赖并构建：
```bash
sudo npm install
sudo npm run build
sudo cp -r dist/* /var/www/edge-tts/
```

3. 配置vite.config.ts以适应生产环境：
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3111,
    host: '0.0.0.0',
    proxy: {
      '/api/tts': {
        target: process.env.API_URL || 'https://tts.2068.online',
        changeOrigin: true,
        secure: false,
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          ui: ['@mui/material', '@mui/icons-material']
        }
      }
    }
  }
})
```

4. 使用PM2管理应用进程：
```bash
# 创建PM2配置文件
sudo nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'edge-tts-web',
    script: 'serve',
    args: '-s dist -l 3000',
    cwd: '/var/edge-tts-web',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    },
    error_file: '/var/log/edge-tts-web-error.log',
    out_file: '/var/log/edge-tts-web-out.log',
    log_file: '/var/log/edge-tts-web.log',
    time: true
  }]
};
```

启动应用：
```bash
# 安装serve用于提供静态文件服务
sudo npm install -g serve

# 使用PM2启动应用
sudo pm2 start ecosystem.config.js

# 设置开机自启
sudo pm2 startup
sudo pm2 save
```

## 常见问题解决

### CORS问题
如果遇到跨域问题，确保Nginx配置中包含以下头部：
```nginx
add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
```

### API请求超时
增加Nginx代理超时时间：
```nginx
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
```

### 大文件上传限制
修改Nginx配置以支持大文件：
```nginx
client_max_body_size 10M;
```

### 性能优化
1. 启用HTTP/2：
   ```nginx
   listen 443 ssl http2;
   ```

2. 配置Brotli压缩：
   ```bash
   sudo apt install brotli
   ```
   添加到Nginx配置：
   ```nginx
   brotli on;
   brotli_comp_level 6;
   brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
   ```

3. 启用缓存：
   ```nginx
   location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
       expires 1y;
       add_header Cache-Control "public, immutable";
   }
   ```

## 监控与日志

### 设置日志轮转
```bash
sudo nano /etc/logrotate.d/edge-tts-web
```

```
/var/log/edge-tts-web*.log {
    daily
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        sudo pm2 reload edge-tts-web
    endscript
}
```

### 监控服务器状态
```bash
# 查看PM2状态
sudo pm2 status

# 查看Nginx状态
sudo systemctl status nginx

# 查看日志
sudo tail -f /var/log/nginx/error.log
```

## 备份策略

### 自动备份脚本
创建备份脚本 `/var/backups/edge-tts-backup.sh`：
```bash
#!/bin/bash

DATE=$(date +%Y-%m-%d-%H%M%S)
BACKUP_DIR="/var/backups/edge-tts"
PROJECT_DIR="/var/edge-tts-web"

mkdir -p $BACKUP_DIR

# 备份代码
tar -czf $BACKUP_DIR/edge-tts-code-$DATE.tar.gz -C $PROJECT_DIR .

# 备份Nginx配置
cp /etc/nginx/sites-available/edge-tts $BACKUP_DIR/nginx-config-$DATE

# 删除30天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
find $BACKUP_DIR -name "nginx-config-*" -mtime +30 -delete

echo "Backup completed: $DATE"
```

设置定时备份：
```bash
sudo chmod +x /var/backups/edge-tts-backup.sh
sudo crontab -e
# 添加以下行，每天凌晨3点备份
0 3 * * * /var/backups/edge-tts-backup.sh
```

---

此文档提供了完整的Edge-TTS Web应用自托管解决方案，如需进一步帮助，请参考各服务官方文档或联系技术支持。