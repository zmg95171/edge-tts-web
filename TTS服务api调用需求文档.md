# TTS服务API调用需求文档

## 1. 项目概述

本项目是一个基于Web的文本转语音（TTS）应用，旨在通过前端界面调用本地TTS服务实现高质量语音合成。项目利用edge-tTS技术在本地运行，避免云端API的限制。

## 2. 当前状态分析

### 2.1 系统架构
- 前端：React + TypeScript + Vite，运行在 `http://localhost:3111`
- 远程TTS服务：运行在 `https://tts.2068.online`
- 代理：Vite开发服务器代理请求

### 2.2 已确认的服务状态
- TTS服务正在运行（健康检查返回正常）
- 代理配置已设置（Vite代理配置正确）
- 请求能够到达TTS服务端点
- 服务返回500错误，表明请求格式可能不匹配

## 3. API调用需求

### 3.1 /tts 端点需求
- **方法**: POST
- **内容类型**: 需要明确支持的Content-Type
- **请求体格式**: 需要明确必需字段和可选字段
- **示例格式**:
  ```json
  {
    "text": "要转换的文本",
    "voice": "声音ID",
    "output_format": "音频格式，如mp3/wav",
    "rate": "语速",
    "volume": "音量",
    "pitch": "音调"
  }
  ```

### 3.2 /voices 端点需求
- **方法**: GET
- **响应格式**: 需要明确返回的声音对象结构
- **示例响应**:
  ```json
  [
    {
      "name": "声音名称",
      "localeName": "区域名称",
      "gender": "性别",
      "voiceTag": {
        "voiceName": "声音标识",
        "codingFormat": "编码格式",
        "styleList": ["风格列表"]
      }
    }
  ]
  ```

## 4. 需要确认的技术细节

### 4.1 TTS服务实现类型
- 是否为原生edge-tts的HTTP包装？
- 是否为自定义TTS实现？
- 是否使用了其他TTS引擎？

### 4.2 具体API规范
- **请求参数格式**：服务期望的具体字段名和值类型
- **响应格式**：返回的音频数据格式（二进制流/BASE64等）
- **错误处理**：不同错误码的含义和处理方式
- **认证方式**：是否需要API密钥或令牌

### 4.3 特殊配置要求
- 最大文本长度限制
- 支持的声音种类和编码格式
- 并发请求限制
- 请求超时设置

## 5. 集成测试计划

### 5.1 直接API测试
1. 使用curl或Postman直接测试TTS服务端点
2. 确认最小可行请求格式
3. 验证不同参数组合的效果

### 5.2 参数调试流程
1. 从最简单的请求开始（仅文本和声音）
2. 逐步添加其他参数
3. 记录每种格式的响应

### 5.3 前端集成验证
1. 确保代理配置正确转发请求
2. 验证请求头设置
3. 测试错误处理和重试机制

## 6. 问题排查清单

- [ ] 确认TTS服务的具体实现和API文档
- [ ] 验证请求参数格式是否匹配服务期望
- [ ] 检查Content-Type头部是否正确设置
- [ ] 确认请求体结构与服务端解析器兼容
- [ ] 验证响应处理逻辑是否正确解析返回数据
- [ ] 测试不同音频格式的兼容性

## 7. 预期成果

完成本文档确认后，应能实现：
1. 前端与TTS服务的无缝通信
2. 正确的文本转语音功能
3. 完整的错误处理机制
4. 可靠的语音列表获取功能

---

## 8. TTS服务

### 8.1 关于TTS服务实现的详细信息
- TTS服务的具体实现方式是什么？（例如：基于edge-tts库的HTTP服务、Python Flask服务、Node.js服务等）
- 是否有现成的API文档或接口说明？
- 服务是否需要特殊的认证或授权？
- 服务是否支持CORS请求？

### 8.2 关于请求参数的详细要求
- 服务是否需要特定的HTTP头部信息？
- 是否需要特定的字符编码？
- 对于文本内容，是否需要特殊处理（如转义字符、编码格式）？
- 声音ID的格式是否严格要求？（如必须包含语言代码、性别等信息）

### 8.3 关于响应数据的处理
- 返回的音频数据是什么格式？（直接二进制流、BASE64编码还是其他格式？）
- 响应头中是否包含重要的元数据？
- 是否需要特殊的响应处理逻辑？

### 8.4 错误处理和日志
- 500错误的具体原因是什么？
- 是否有服务端日志可以帮助诊断问题？
- 不同类型的错误（如无效声音ID、过长文本等）返回的错误格式是什么？

### 8.5 性能和限制
- 服务是否有限制（如并发数、请求频率、文本长度等）？
- 生成音频的平均耗时是多少？
- 是否支持音频缓存机制？

---
**文档创建日期**: 2026年1月13日  
**最后更新**: 2026年1月13日

## 9. TTS服务调用回复

基于 `server/tts-server.ts` 代码实现的详细回答：

### 9.1 TTS服务实现
- **实现方式**: Node.js Express 服务，内部通过 `child_process` 调用 Python 的 `edge-tts` 命令行工具进行语音合成。
- **接口文档**:
  - `GET /api/tts/voices`: 获取可用声音列表。
  - `POST /api/tts/speak`: 语音合成接口。
  - `GET /api/tts/health`: 健康检查。
- **认证/授权**: 当前实现**不需要**任何认证或API Key。
- **CORS**: 支持，代码已配置 `app.use(cors())`，允许跨域请求。

### 9.2 请求参数要求
- **HTTP头部**: POST请求通常需要 `Content-Type: application/json`。
- **字符编码**: UTF-8。
- **文本处理**: 客户端发送原始文本即可。服务端内部有 `escapeText` 函数处理特殊字符（如引号）。
- **声音ID**: 格式需符合 `edge-tts` 规范（如 `en-US-JennyNeural`）。如果未提供，默认使用 `en-US-JennyNeural`。支持的声音列表可在 `GET /api/tts/voices` 中获取。

### 9.3 响应数据处理
- **音频格式**: MP3格式的二进制流 (`audio/mpeg`)。
- **响应头**:
  - `Content-Type: audio/mpeg`
  - `Content-Length`: 音频大小
  - `Cache-Control: public, max-age=86400` (通知浏览器缓存24小时)
- **特殊处理**: 客户端应以 Blob 或 ArrayBuffer 接收响应数据。

### 9.4 错误处理
- **500错误原因**: 通常是 `edge-tts` 命令行工具执行失败（如网络问题、参数错误）或生成的音频文件为空。
- **服务端日志**: 服务端会打印请求详情 (`TTS Request: ...`) 和 错误信息 (`console.error`)，可用于诊断。
- **错误格式**: JSON格式，例如 `{ "success": false, "error": "Text is required" }` 或 `{ "success": false, "error": "TTS synthesis failed", "details": "..." }`。

### 9.5 性能和限制
- **限制**:
  - **超时**: 内部执行 `edge-tts` 命令的超时时间设置为 30秒。
  - **并发**: Node.js 单线程非阻塞，但 `edge-tts` 是独立进程，并发过高可能会占用较多 CPU/网络资源。
- **缓存机制**:
  - **服务端**: 生成音频后立即读取并返回，随后**删除临时文件**，服务端每次请求都重新生成，不保留缓存文件。
  - **客户端**: 通过 `Cache-Control` 头建议浏览器进行缓存。